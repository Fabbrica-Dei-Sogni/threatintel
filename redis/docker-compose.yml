# docker-compose.yml - Solo servizi di supporto

services:
  redis-ratelimit:
    image: redis:7.2-alpine
    container_name: honeypot-ratelimit
    restart: unless-stopped
    ports:
      - "6379:6379"  # Accessibile solo da localhost
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    command: >
      redis-server 
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
      --appendfsync everysec
      --no-appendfsync-on-rewrite yes
      --auto-aof-rewrite-percentage 100
      --auto-aof-rewrite-min-size 64mb
      --tcp-keepalive 300
      --timeout 300
      --bind 0.0.0.0
      --port 6379
    volumes:
      - redis-data:/data
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - honeypot-support
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redisinsight:
    image: redis/redisinsight:latest
    container_name: redisinsight
    restart: unless-stopped
    ports:
      - "127.0.0.1:5540:5540"  # Porta web di RedisInsight accessibile su localhost:5540
    volumes:
      - redisinsight-data:/data
    networks:
      - honeypot-support
    depends_on:
      redis-ratelimit:
        condition: service_healthy

  # Opzionale: Redis monitoring
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: honeypot-redis-exporter
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis://honeypot-redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    ports:
      - "127.0.0.1:9121:9121"
    networks:
      - honeypot-support
    depends_on:
      redis-ratelimit:
        condition: service_healthy

volumes:
  redisinsight-data: 
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./redisinsight-data    
  redis-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./redis-data

networks:
  honeypot-support:
    driver: bridge
    name: honeypot-support-net
    ipam:
      config:
        - subnet: 172.25.0.0/16
          gateway: 172.25.0.1
